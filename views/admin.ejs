<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Administration - Intranet</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- CSS GLOBAL --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { display: flex; background-color: #f4f6f8; min-height: 100vh; }
        
        /* --- SIDEBAR --- */
        .sidebar { width: 260px; background-color: #EAEAEA; display: flex; flex-direction: column; padding: 25px 0; height: 100vh; position: fixed; border-right: 1px solid #d1d1d1; }
        .logo { text-align: center; font-size: 28px; font-weight: 800; color: #000; margin-bottom: 40px; letter-spacing: 1px; }
        
        .menu-items { list-style: none; flex-grow: 1; }
        .menu-items li { cursor: pointer; } 
        .menu-items a { display: flex; align-items: center; padding: 12px 30px; text-decoration: none; color: #333; font-size: 15px; font-weight: 500; transition: 0.3s; gap: 15px; pointer-events: none; }
        
        .menu-items li:hover { background-color: #d6d6d6; }
        .menu-items li.active { background-color: #d1d1d1; font-weight: 700; border-left: 4px solid #333; }
        
        .logout-item { margin-top: auto; margin-bottom: 20px; }
        .logout-item a { color: #c0392b !important; font-weight: bold; pointer-events: auto; }

        /* --- CONTENU PRINCIPAL --- */
        .main-content { margin-left: 260px; padding: 50px; width: 100%; }
        
        /* Sections (cach√©es par d√©faut sauf la premi√®re) */
        .content-section { display: none; animation: fadeIn 0.3s; }
        .content-section.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CARTES STATS --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px; border-bottom: 3px solid transparent; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); }
        
        .stat-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; }
        .stat-info h3 { font-size: 24px; font-weight: 800; margin: 0; }
        .stat-info p { color: #666; font-size: 13px; margin: 0; }

        /* --- TABLEAUX --- */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .section-title { font-size: 24px; border-left: 5px solid #333; padding-left: 15px; font-weight: bold; color: #333; }
        
        .table-container { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; border-bottom: 2px solid #eee; color: #7f8c8d; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; }
        td { padding: 15px; border-bottom: 1px solid #f1f1f1; font-size: 14px; color: #2c3e50; vertical-align: middle; }
        
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .badge-pending { background: #fff3cd; color: #856404; }
        .badge-approved { background: #d4edda; color: #155724; }
        .badge-rejected { background: #fadbd8; color: #c0392b; }
        .badge-active { background: #d4edda; color: #155724; }
        .badge-inactive { background: #e2e3e5; color: #383d41; }
        .badge-high { background: #f8d7da; color: #721c24; }

        .btn-action { padding: 6px 12px; border: none; border-radius: 5px; cursor: pointer; color: white; margin-right: 5px; transition: 0.2s; font-size: 12px; }
        .btn-valid { background-color: #27ae60; }
        .btn-refuse { background-color: #e74c3c; }
        .btn-edit { background-color: #f39c12; }
        .btn-delete { background-color: #c0392b; }
        .btn-action:hover { opacity: 0.8; }

        .btn-primary { background: #2c3e50; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; font-size: 14px; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary:hover { background: #1a252f; }
        
        .avatar-circle { width: 35px; height: 35px; background: #3498db; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; margin-right: 10px; }
        .user-flex { display: flex; align-items: center; }

        /* Formulaire ajout employ√© */
        .form-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .form-modal.active { display: flex; align-items: center; justify-content: center; }
        .form-content { background: white; padding: 30px; border-radius: 10px; width: 500px; max-width: 90%; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
    </style>
</head>
<body>

    <% 
        var finalStatus = (typeof user !== 'undefined' && user && user.systemStatus) ? user.systemStatus : 'Op√©rationnel';
        var itColor = (finalStatus === 'Panne') ? '#c0392b' : '#27ae60'; 
        var ticketCount = (typeof nbTickets !== 'undefined') ? nbTickets : 0;
        var prenom = (typeof user !== 'undefined' && user && user.prenom) ? user.prenom : 'Admin';
        var nom = (typeof user !== 'undefined' && user && user.nom) ? user.nom : '';
        var employes = (typeof employes !== 'undefined') ? employes : [];
        var conges = (typeof conges !== 'undefined') ? conges : [];
    %>

    <nav class="sidebar">
        <div class="logo">ENTREPRISE</div> 
        <ul class="menu-items">
            <li class="active" onclick="switchTab('dashboard', this)">
                <a href="#"><i class="fas fa-chart-line"></i> Vue d'ensemble</a>
            </li>
            <li onclick="switchTab('employees', this)">
                <a href="#"><i class="fas fa-users"></i> G√©rer Employ√©s</a>
            </li>
            <li onclick="switchTab('validations', this)">
                <a href="#"><i class="fas fa-check-circle"></i> Validations</a>
            </li>
            <li onclick="switchTab('it-status', this)">
                <a href="#"><i class="fas fa-server"></i> Statut IT</a>
            </li>
            
            <li class="logout-item">
                <a href="/logout"><i class="fas fa-sign-out-alt"></i> D√©connexion</a>
            </li>
        </ul>
    </nav>

    <main class="main-content">
        
        <!-- SECTION DASHBOARD -->
        <div id="dashboard" class="content-section active">
            <div class="section-header">
                <div>
                    <h1>Bonjour, <%= prenom %> <%= nom %> üëã</h1>
                    <p style="color: #7f8c8d; margin-top: 5px;">Voici ce qu'il se passe aujourd'hui.</p>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card" style="border-bottom-color: #3498db;">
                    <div class="stat-icon" style="background-color: #3498db;"><i class="fas fa-envelope"></i></div>
                    <div class="stat-info"><h3><%= ticketCount %></h3><p>Tickets IT Ouverts</p></div>
                </div>
                <div class="stat-card" style="border-bottom-color: #27ae60;">
                    <div class="stat-icon" style="background-color: #27ae60;"><i class="fas fa-users"></i></div>
                    <div class="stat-info"><h3><%= typeof nbEmployes !== 'undefined' ? nbEmployes : 0 %></h3><p>Employ√©s Actifs</p></div>
                </div>
                <div class="stat-card" style="border-bottom-color: #f39c12;">
                    <div class="stat-icon" style="background-color: #f39c12;"><i class="fas fa-clock"></i></div>
                    <div class="stat-info"><h3><%= typeof nbConges !== 'undefined' ? nbConges : 0 %></h3><p>Cong√©s en Attente</p></div>
                </div>
                <div class="stat-card" style="border-bottom-color: <%= itColor %>;">
                    <div class="stat-icon" style="background-color: <%= itColor %>;"><i class="fas fa-server"></i></div>
                    <div class="stat-info"><h3><%= finalStatus %></h3><p>Statut Syst√®me</p></div>
                </div>
            </div>
        </div>

        <!-- SECTION G√âRER EMPLOY√âS -->
        <div id="employees" class="content-section">
            <div class="section-header">
                <h2 class="section-title">G√©rer les Employ√©s</h2>
                <button class="btn-primary" onclick="openAddEmployeeModal()"><i class="fas fa-plus"></i> Ajouter un Employ√©</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nom</th>
                            <th>Pr√©nom</th>
                            <th>Email</th>
                            <th>R√¥le</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="employees-table-body">
                        <% if (typeof employes !== 'undefined' && employes.length > 0) { %>
                            <% employes.forEach(function(emp) { %>
                                <tr>
                                    <td><%= emp.id_employe %></td>
                                    <td><%= emp.nom %></td>
                                    <td><%= emp.prenom %></td>
                                    <td><%= emp.email %></td>
                                    <td><span class="status-badge <%= emp.role === 'admin' ? 'badge-active' : 'badge-pending' %>"><%= emp.role || 'employe' %></span></td>
                                    <td><span class="status-badge badge-active">Actif</span></td>
                                    <td>
                                        <button class="btn-action btn-edit" onclick="editEmployee(<%= emp.id_employe %>)"><i class="fas fa-edit"></i></button>
                                        <button class="btn-action btn-delete" onclick="deleteEmployee(<%= emp.id_employe %>)"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px; color: #999;">Aucun employ√© trouv√©. Cliquez sur "Ajouter un Employ√©" pour commencer.</td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- SECTION VALIDATIONS (CONG√âS) -->
        <div id="validations" class="content-section">
            <div class="section-header">
                <h2 class="section-title">Validations des Cong√©s</h2>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Employ√©</th>
                            <th>Type</th>
                            <th>Date D√©but</th>
                            <th>Date Fin</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="conges-table-body">
                        <% if (typeof conges !== 'undefined' && conges.length > 0) { %>
                            <% conges.forEach(function(conge) { %>
                                <tr>
                                    <td><%= conge.id_conge || 'N/A' %></td>
                                    <td><%= conge.prenom_employe || 'N/A' %> <%= conge.nom_employe || '' %></td>
                                    <td><%= conge.type || 'Cong√©s Pay√©s' %></td>
                                    <td><%= conge.date_debut ? new Date(conge.date_debut).toLocaleDateString('fr-FR') : 'N/A' %></td>
                                    <td><%= conge.date_fin ? new Date(conge.date_fin).toLocaleDateString('fr-FR') : 'N/A' %></td>
                                    <td>
                                        <span class="status-badge <%= conge.statut === 'approuve' ? 'badge-approved' : (conge.statut === 'refuse' ? 'badge-rejected' : 'badge-pending') %>">
                                            <%= conge.statut === 'approuve' ? 'Approuv√©' : (conge.statut === 'refuse' ? 'Refus√©' : 'En Attente') %>
                                        </span>
                                    </td>
                                    <td>
                                        <% if (!conge.statut || conge.statut === 'en_attente') { %>
                                            <button class="btn-action btn-valid" onclick="validerConge(<%= conge.id_conge || 0 %>)"><i class="fas fa-check"></i> Approuver</button>
                                            <button class="btn-action btn-refuse" onclick="refuserConge(<%= conge.id_conge || 0 %>)"><i class="fas fa-times"></i> Refuser</button>
                                        <% } else { %>
                                            <span style="color: #999; font-size: 12px;">Trait√©</span>
                                        <% } %>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px; color: #999;">Aucune demande de cong√© en attente.</td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- SECTION STATUT IT -->
        <div id="it-status" class="content-section">
            <div class="section-header">
                <h2 class="section-title">Statut IT</h2>
            </div>

            <div class="stats-grid">
                <div class="stat-card" style="border-bottom-color: <%= itColor %>;">
                    <div class="stat-icon" style="background-color: <%= itColor %>;"><i class="fas fa-server"></i></div>
                    <div class="stat-info">
                        <h3><%= finalStatus %></h3>
                        <p>Serveur Principal</p>
                    </div>
                </div>
                <div class="stat-card" style="border-bottom-color: #27ae60;">
                    <div class="stat-icon" style="background-color: #27ae60;"><i class="fas fa-database"></i></div>
                    <div class="stat-info">
                        <h3>Op√©rationnel</h3>
                        <p>Base de Donn√©es</p>
                    </div>
                </div>
                <div class="stat-card" style="border-bottom-color: #27ae60;">
                    <div class="stat-icon" style="background-color: #27ae60;"><i class="fas fa-network-wired"></i></div>
                    <div class="stat-info">
                        <h3>Connect√©</h3>
                        <p>R√©seau</p>
                    </div>
                </div>
                <div class="stat-card" style="border-bottom-color: #3498db;">
                    <div class="stat-icon" style="background-color: #3498db;"><i class="fas fa-envelope"></i></div>
                    <div class="stat-info">
                        <h3><%= ticketCount %></h3>
                        <p>Tickets Ouverts</p>
                    </div>
                </div>
            </div>

            <div class="table-container" style="margin-top: 30px;">
                <h3 style="margin-bottom: 20px; color: #333;">Tickets IT R√©cents</h3>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Titre</th>
                            <th>Priorit√©</th>
                            <th>Statut</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>#001</td>
                            <td>Probl√®me d'acc√®s r√©seau</td>
                            <td><span class="status-badge badge-high">Haute</span></td>
                            <td><span class="status-badge badge-pending">En cours</span></td>
                            <td>10/01/2024</td>
                        </tr>
                        <tr>
                            <td>#002</td>
                            <td>Mise √† jour logiciel</td>
                            <td><span class="status-badge badge-pending">Moyenne</span></td>
                            <td><span class="status-badge badge-approved">R√©solu</span></td>
                            <td>08/01/2024</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- MODAL AJOUT EMPLOY√â -->
    <div id="employeeModal" class="form-modal" onclick="if(event.target === this) closeAddEmployeeModal()">
        <div class="form-content">
            <h2 style="margin-bottom: 20px;">Ajouter un Employ√©</h2>
            <form id="employeeForm" onsubmit="addEmployee(event)">
                <div class="form-group">
                    <label>Pr√©nom</label>
                    <input type="text" name="prenom" required>
                </div>
                <div class="form-group">
                    <label>Nom</label>
                    <input type="text" name="nom" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email" required>
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" name="mot_de_passe" required>
                </div>
                <div class="form-group">
                    <label>R√¥le</label>
                    <select name="role" required>
                        <option value="employe">Employ√©</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn-action btn-refuse" onclick="closeAddEmployeeModal()">Annuler</button>
                    <button type="submit" class="btn-action btn-valid">Ajouter</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Fonction pour basculer entre les onglets
        function switchTab(tabId, element) {
            // Masquer toutes les sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Afficher la section s√©lectionn√©e
            const selectedSection = document.getElementById(tabId);
            if (selectedSection) {
                selectedSection.classList.add('active');
            }
            
            // Retirer la classe active de tous les √©l√©ments du menu
            document.querySelectorAll('.menu-items li').forEach(li => {
                li.classList.remove('active');
            });
            
            // Ajouter la classe active √† l'√©l√©ment cliqu√©
            if (element) {
                element.classList.add('active');
            }
        }

        // Modal Ajout Employ√©
        function openAddEmployeeModal() {
            document.getElementById('employeeModal').classList.add('active');
        }

        function closeAddEmployeeModal() {
            document.getElementById('employeeModal').classList.remove('active');
            document.getElementById('employeeForm').reset();
        }

        function addEmployee(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);
            
            // Ici, vous pouvez envoyer les donn√©es au serveur via fetch
            fetch('/admin/employees/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('Employ√© ajout√© avec succ√®s !');
                    location.reload();
                } else {
                    alert('Erreur : ' + result.message);
                }
            })
            .catch(err => {
                console.error(err);
                alert('Erreur lors de l\'ajout de l\'employ√©');
            });
        }

        function editEmployee(id) {
            alert('Modifier l\'employ√© #' + id + ' (Fonctionnalit√© √† impl√©menter)');
        }

        function deleteEmployee(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet employ√© ?')) {
                fetch('/admin/employees/delete/' + id, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('Employ√© supprim√© avec succ√®s !');
                        location.reload();
                    } else {
                        alert('Erreur : ' + result.message);
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Erreur lors de la suppression');
                });
            }
        }

        function validerConge(id) {
            if (confirm('Approuver cette demande de cong√© ?')) {
                fetch('/admin/conges/valider/' + id, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('Cong√© approuv√© !');
                        location.reload();
                    } else {
                        alert('Erreur : ' + result.message);
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Erreur lors de la validation');
                });
            }
        }

        function refuserConge(id) {
            if (confirm('Refuser cette demande de cong√© ?')) {
                fetch('/admin/conges/refuser/' + id, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('Cong√© refus√©.');
                        location.reload();
                    } else {
                        alert('Erreur : ' + result.message);
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Erreur lors du refus');
                });
            }
        }
    </script>
</body>
</html>
